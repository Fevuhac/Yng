var pomelo=require("pomelo"),path=require("path");global.logger=require("pomelo-logger").getLogger("default");require("./app/utils/globals");var routeUtil=require("./app/utils/routeUtil"),decryptFilter=require("./app/servers/common/decryptFilter"),playerFilter=require("./app/servers/game/filter/playerFilter"),redisClient=require("./app/utils/import_db").redisClient;process.on("uncaughtException",function(a){console.error(" Caught exception: "+a.stack)});
process.on("unhandledRejection",function(a,b){console.log("Unhandled Rejection at: Promise ",b," reason: ",a)});
var app=pomelo.createApp(),configure=function(){app.set("name","fish room");app.loadConfig("redis",path.join(app.getBase(),"../database/config/database/redis.json"));app.loadConfig("mysql",path.join(app.getBase(),"../database/config/database/mysql.json"));app.set("errorHandler",function(a,b,e,c,d){logger.error("-------errorHandler happend ----\x3e",a);c.__session__.__socket__.socket.close();d()});app.configure("production|development",function(){app.enable("systemMonitor");app.before(pomelo.filters.toobusy());
app.filter(pomelo.filters.timeout());app.before(decryptFilter);var a=require("./app/modules/onlineUser"),b=require("./app/modules/gameInfo");"function"===typeof app.registerAdmin&&(app.registerAdmin(a,{app:app}),app.registerAdmin(b,{app:app}));app.get("redis");app.set("proxyConfig",{cacheMsg:!0,interval:30,lazyConnection:!0});app.set("remoteConfig",{cacheMsg:!0,interval:30})});app.configure("production|development","gate",function(){global.logger=require("pomelo-logger").getLogger("gate");app.set("connectorConfig",
{connector:pomelo.connectors.hybridconnector,useDict:!0,useProtobuf:!0});app.gate=require("./app/logic/gate/gate");app.gate.start();app.beforeStopHook(function(){app.gate.stop()})});app.configure("production|development","connector",function(){global.logger=require("pomelo-logger").getLogger("connector");app.set("connectorConfig",{connector:pomelo.connectors.hybridconnector,heartbeat:10,useDict:!0,useProtobuf:!0});app.entry=require("./app/logic/connector/entry");app.entry.start();app.beforeStopHook(function(){app.entry.stop()})});
app.configure("production|development","auth",function(){global.logger=require("pomelo-logger").getLogger("auth");app.auth=require("./app/logic/auth/auth");app.auth.start();app.beforeStopHook(function(){app.auth.stop()})});app.configure("production|development","game",function(){global.logger=require("pomelo-logger").getLogger("game");app.set("redisClient",redisClient);app.filter(playerFilter);app.game=require("./app/logic/game/game");app.game.start();app.beforeStopHook(function(){app.game.stop()})});
app.configure("production|development","balance",function(){global.logger=require("pomelo-logger").getLogger("balance");app.balance=require("./app/logic/balance/loadManager");app.balance.start();app.beforeStopHook(function(){app.balance.stop()})});app.configure("production|development","dataSync",function(){global.logger=require("pomelo-logger").getLogger("dataSync");app.dataSync=require("./app/logic/dataSync/dataSync");app.dataSync.start();app.beforeStopHook(function(){app.dataCenter.stop()})})};
configure();app.start();
